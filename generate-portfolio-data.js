const fs = require("fs")
const path = require("path")

// Root folder where your images live
const portfolioRoot = path.join(__dirname, "public/images/portfolio")

// Must match next.config.js basePath
const BASE_PATH = "/PiyushWebsite"

// Helper to safely read files in a folder
function getFiles(folder) {
  return fs.existsSync(folder) ? fs.readdirSync(folder) : []
}

// Normalize paths for browser use (convert Windows backslashes to forward slashes)
function normalizePath(p) {
  return p.replace(/\\/g, "/")
}

function generatePortfolioData() {
  const portfolioData = {}

  // Loop categories
  const categories = getFiles(portfolioRoot)
  for (const category of categories) {
    const categoryPath = path.join(portfolioRoot, category)
    if (!fs.statSync(categoryPath).isDirectory()) continue

    const categoryThumbnail = normalizePath(
      path.join(BASE_PATH, "images/portfolio", category, "thumbnail.jpg")
    )

    portfolioData[category] = {
      title: category,
      thumbnail: categoryThumbnail,
      projects: {}
    }

    // Loop projects
    const projects = getFiles(categoryPath)
    for (const project of projects) {
      const projectPath = path.join(categoryPath, project)
      if (!fs.statSync(projectPath).isDirectory()) continue

      const projectThumbnail = normalizePath(
        path.join(BASE_PATH, "images/portfolio", category, project, "thumbnail.jpg")
      )

      portfolioData[category].projects[project] = {
        title: project,
        thumbnail: projectThumbnail,
        description: [`Description for ${project}`],
        images: [], // optional project-level images
        fields: {}
      }

      // Loop fields
      const fields = getFiles(projectPath)
      for (const field of fields) {
        const fieldPath = path.join(projectPath, field)
        if (!fs.statSync(fieldPath).isDirectory()) continue

        const fieldFiles = getFiles(fieldPath)
        const fieldImages = fieldFiles
          .filter(f => f !== "thumbnail.jpg")
          .map(f =>
            normalizePath(
              path.join(BASE_PATH, "images/portfolio", category, project, field, f)
            )
          )

        const fieldThumbnail = normalizePath(
          path.join(BASE_PATH, "images/portfolio", category, project, field, "thumbnail.jpg")
        )

        portfolioData[category].projects[project].fields[field] = {
          title: field,
          description: `Description for ${field}`,
          images: fieldImages,
          thumbnail: fieldThumbnail
        }
      }
    }
  }

  // Write out TypeScript file
  const outputPath = path.join(__dirname, "lib/data/portfolio.ts")
  const tsContent = `
// Auto-generated by generate-portfolio-data.js

export type FieldData = {
  title: string
  description: string
  images: string[]
  thumbnail: string
}

export type SubProject = {
  title: string
  thumbnail: string
  images: string[]
  description: string[]
  fields: Record<string, FieldData>
}

export type CategoryData = {
  title: string
  thumbnail: string
  projects: Record<string, SubProject>
}

export const portfolioData: Record<string, CategoryData> = ${JSON.stringify(portfolioData, null, 2)}
`

  fs.writeFileSync(outputPath, tsContent, "utf-8")
  console.log("âœ… portfolio.ts regenerated successfully with BASE_PATH support")
}

generatePortfolioData()